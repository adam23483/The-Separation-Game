<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white font-sans">
<head>
  <meta charset="UTF-8">
  <title>The Separation Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
  </style>
</head>
<body class="p-6">

<header class="text-center py-16 px-4 bg-gray-800 rounded-xl shadow-lg mb-6">
  <h1 class="text-4xl sm:text-5xl font-bold text-emerald-400 mb-4">The Separation Game</h1>
  <p class="text-gray-300 text-lg mb-6">Connect any two soccer players through shared teammates.</p>
  <div class="flex flex-wrap justify-center gap-4">
    <a href="index.html" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-6 py-3 rounded">🏠 Home</a>
    <a href="challenge_mode.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">🎮 Challenge Mode</a>
    <a href="howtoplay.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">📘 How To Play</a>
    <a href="lookup.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">🔍 Link Lookup</a>
    <a href="leaderboard.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">🏆 Leaderboard</a>
  </div>
</header>

<main class="max-w-5xl mx-auto bg-gray-800 p-6 rounded-lg">
  <!-- Challenge Display -->
  <div class="flex items-center justify-center gap-8 mb-8">
    <div class="text-center">
      <img id="playerAImg" src="" alt="Player A" class="w-24 h-24 object-cover rounded-full mx-auto mb-2 border-2 border-emerald-500">
      <p id="playerAName" class="font-bold text-lg"></p>
      <div id="playerATeams" class="text-sm text-gray-400"></div>
    </div>
    <span class="text-3xl font-bold text-indigo-300">→</span>
    <div class="text-center">
      <img id="playerBImg" src="" alt="Player B" class="w-24 h-24 object-cover rounded-full mx-auto mb-2 border-2 border-indigo-500">
      <p id="playerBName" class="font-bold text-lg"></p>
      <div id="playerBTeams" class="text-sm text-gray-400"></div>
    </div>
  </div>

  <!-- Current Path -->
  <h2 class="text-2xl font-bold text-indigo-400 mb-4">🧠 Guided Path Mode</h2>
  <p><strong>Current Path:</strong> <span id="guidedPathDisplay"></span></p>

  <!-- Move Options -->
  <div id="nextMoves" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mt-6"></div>
  <p id="guidedFeedback" class="mt-6 text-lg font-bold text-emerald-400"></p>
</main>

<script>
let guidedPath = [];
let guidedPlayerB = '';
let guidedScore = 100;
let mistakes = 0;
let startTime = 0;
let randomPair = null;

async function fetchChallengesAndStart() {
    const res = await fetch('/daily_challenges');
    const data = await res.json();
    const pairs = data.pairs;
    if (pairs.length === 0) {
        alert("No daily challenges available.");
        return;
    }
    randomPair = pairs[Math.floor(Math.random() * pairs.length)];
    startGuidedGame(randomPair.player_a.name, randomPair.player_b.name);
}

async function startGuidedGame(playerA, playerB) {
    guidedPath = [playerA];
    guidedPlayerB = playerB;
    guidedScore = 100;
    mistakes = 0;
    startTime = Date.now();
    document.getElementById('guidedFeedback').textContent = '';
    updateGuidedDisplay();

    document.getElementById('playerAName').textContent = playerA;
    document.getElementById('playerBName').textContent = playerB;

    document.getElementById('playerAImg').src = `https://cdn.example.com/players/${playerA.toLowerCase().replace(/\s/g, "_")}.jpg`;
    document.getElementById('playerBImg').src = `https://cdn.example.com/players/${playerB.toLowerCase().replace(/\s/g, "_")}.jpg`;

    const formatLatestTeam = (teams) => {
        if (!teams.length) return "No team info";
        const t = teams[teams.length - 1];
        return `${t.team} (${t.league}, ${t.season_range})`;
    };

    document.getElementById('playerATeams').innerHTML = formatLatestTeam(randomPair.player_a.teams);
    document.getElementById('playerBTeams').innerHTML = formatLatestTeam(randomPair.player_b.teams);

    await fetchNextMoves();
}

function updateGuidedDisplay() {
    document.getElementById('guidedPathDisplay').textContent = guidedPath.join(' → ');
}

async function fetchNextMoves() {
    const response = await fetch('/guided_next_moves', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ current_path: guidedPath, player_b: guidedPlayerB })
    });
    const data = await response.json();
    const container = document.getElementById('nextMoves');
    container.innerHTML = '';

    if (data.error) {
        alert(data.error);
        return;
    }

    data.options.forEach(option => {
        const card = document.createElement('div');
        card.className = 'bg-gray-700 rounded-lg p-4 hover:bg-gray-600 cursor-pointer text-center fade-in';
        card.onclick = () => selectNextMove(option);

        const img = document.createElement('img');
        img.src = `https://cdn.example.com/players/${option.name.toLowerCase().replace(/\s/g, "_")}.jpg`;
        img.alt = option.name;
        img.className = 'w-20 h-20 rounded-full mx-auto mb-2 object-cover border-2 border-gray-400';

        const name = document.createElement('p');
        name.textContent = option.name;
        name.className = 'font-bold text-md mb-1';

        const teamList = document.createElement('div');
        teamList.className = 'text-sm text-gray-300';
        teamList.innerHTML = (option.team_history || []).slice(-5).map(
            t => `${t.team} (${t.league}, ${t.season_range})`
        ).join("<br>") || `${option.team} (${option.league}, ${option.season_range})`;

        card.appendChild(img);
        card.appendChild(name);
        card.appendChild(teamList);
        container.appendChild(card);
    });
}

async function selectNextMove(option) {
    const container = document.getElementById('nextMoves');
    const feedback = document.getElementById('guidedFeedback');

    if (option.is_correct) {
        guidedPath.push(option.name);
        updateGuidedDisplay();
        if (option.name === guidedPlayerB) {
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);
            const scoreLoss = (mistakes * 10) + (guidedPath.length - 2) * 5 + timeTaken * 0.1;
            const finalScore = Math.max(0, guidedScore - scoreLoss);
            feedback.textContent = `🎉 Completed! Score: ${finalScore.toFixed(2)} (Mistakes: ${mistakes}, Links: ${guidedPath.length - 1}, Time: ${timeTaken}s)`;
            container.innerHTML = '';
        } else {
            await fetchNextMoves();
        }
    } else {
        mistakes += 1;
        guidedScore -= 10;
        feedback.textContent = `❌ Nope! ${option.name} is not on the path.`;

        const cards = container.querySelectorAll('div');
        cards.forEach(card => {
            if (card.textContent.includes(option.name)) {
                card.classList.add('opacity-50', 'line-through', 'cursor-not-allowed');
                card.onclick = null;
            }
        });
    }
}

fetchChallengesAndStart();
</script>

</body>
</html>
