<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white font-sans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Link Lookup - The Separation Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="p-6">

<header class="text-center py-16 px-4 bg-gray-800 rounded-xl shadow-lg p-6 mb-4">
  <h1 class="text-4xl sm:text-5xl font-bold text-emerald-400 mb-4">The Separation Game</h1>
  <p class="text-gray-300 text-lg mb-6">Connect any two soccer players through shared teammates.</p>
  <div class="flex flex-wrap justify-center gap-4">
    <a href="index.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">🏠 Home</a>
    <a href="challenge_mode.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">🎮 Challenge Mode</a>
    <a href="howtoplay.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">📘 How To Play</a>
    <a href="lookup.html" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold px-6 py-3 rounded">🔍 Link Lookup</a>
    <a href="leaderboard.html" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-3 rounded">🏆 Leaderboard</a>
  </div>
</header>

<main class="max-w-4xl mx-auto bg-gray-800 p-6 rounded-xl shadow-md">
  <form id="linkForm" class="space-y-8">
    <h1 class="text-4xl font-bold text-emerald-400 mb-4 text-center">🔍 Link Lookup</h1>
    <p class="text-gray-300 text-lg text-center">Find connections between soccer players.</p>
    <!-- Player A -->
    <div>
      <h3 class="text-lg font-semibold text-white mb-2">Player A</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
        <select id="leagueA" class="bg-gray-900 text-white border border-gray-600 rounded px-3 py-2">
          <option value="">Select League</option>
        </select>
        <select id="teamA" class="bg-gray-900 text-white border border-gray-600 rounded px-3 py-2">
          <option value="">Select Team</option>
        </select>
        <select id="seasonA" class="bg-gray-900 text-white border border-gray-600 rounded px-3 py-2">
          <option value="">Select Season</option>
        </select>
      </div>
      <input id="playerA" name="playerA" type="text" list="playerList" class="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded text-white" placeholder="Enter first player..." />
    </div>

    <!-- Player B -->
    <div>
      <h3 class="text-lg font-semibold text-white mb-2">Player B</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2">
        <select id="leagueB" class="bg-gray-900 text-white border border-gray-600 rounded px-3 py-2">
          <option value="">Select League</option>
        </select>
        <select id="teamB" class="bg-gray-900 text-white border border-gray-600 rounded px-3 py-2">
          <option value="">Select Team</option>
        </select>
        <select id="seasonB" class="bg-gray-900 text-white border border-gray-600 rounded px-3 py-2">
          <option value="">Select Season</option>
        </select>
      </div>
      <input id="playerB" name="playerB" type="text" list="playerList" class="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded text-white" placeholder="Enter second player..." />
    </div>

    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded font-semibold">🔍 Find Connection</button>
  </form>

  <datalist id="playerList"></datalist>

  <div id="results" class="mt-8 hidden">
    <h2 class="text-xl font-semibold text-indigo-400 mb-4">Results</h2>
    <div id="resultsContent" class="space-y-4 text-sm text-gray-200"></div>
  </div>
</main>

<script>
  function setupFilters(filters, prefix) {
    const leagueSel = document.getElementById(`league${prefix}`);
    const teamSel = document.getElementById(`team${prefix}`);
    const seasonSel = document.getElementById(`season${prefix}`);

    leagueSel.onchange = () => {
      const league = leagueSel.value;
      const teams = filters[league] || {};
      teamSel.innerHTML = '<option value="">Select Team</option>';
      seasonSel.innerHTML = '<option value="">Select Season</option>';
      Object.keys(teams).forEach(team => {
        teamSel.add(new Option(team, team));
      });
    };

    teamSel.onchange = () => {
      const league = leagueSel.value;
      const team = teamSel.value;
      const seasons = Object.keys(filters[league]?.[team] || {});
      seasonSel.innerHTML = '<option value="">Select Season</option>';
      seasons.forEach(season => seasonSel.add(new Option(season, season)));
    };

    seasonSel.onchange = () => {
      const league = leagueSel.value;
      const team = teamSel.value;
      const season = seasonSel.value;
      const players = filters[league]?.[team]?.[season] || [];
      const playerInput = document.getElementById(`player${prefix}`);
      playerInput.value = '';
      const list = document.getElementById('playerList');
      list.innerHTML = '';
      players.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        list.appendChild(option);
      });
    };
  }

  async function loadPlayerList() {
    const res = await fetch('http://localhost:5000/filters');
    const filters = await res.json();

    setupFilters(filters, 'A');
    setupFilters(filters, 'B');

    const allPlayers = new Set();
    for (const league in filters) {
      for (const team in filters[league]) {
        for (const season in filters[league][team]) {
          filters[league][team][season].forEach(name => allPlayers.add(name));
        }
      }
    }

    const list = document.getElementById('playerList');
    Array.from(allPlayers).sort().forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      list.appendChild(option);
    });

    Object.keys(filters).sort().forEach(league => {
      const optA = new Option(league, league);
      const optB = new Option(league, league);
      document.getElementById('leagueA').add(optA);
      document.getElementById('leagueB').add(optB);
    });
  }

  document.getElementById('linkForm').addEventListener('submit', async e => {
    e.preventDefault();
    const playerA = document.getElementById('playerA').value.trim();
    const playerB = document.getElementById('playerB').value.trim();
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');

    if (!playerA || !playerB) return alert("Please enter both players.");

    resultsDiv.classList.remove("hidden");
    resultsContent.innerHTML = "<p>Loading...</p>";

    const res = await fetch("http://localhost:5000/connect", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ player_a: playerA, player_b: playerB })
    });

    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0 || data.error) {
      resultsContent.innerHTML = `<p>${data.error || 'No connections found.'}</p>`;
      return;
    }
    resultsContent.innerHTML = data.map((item, i) => {
      const pathLines = item.path.split(' → ').map((segment, idx) => {
        const match = segment.match(/^(.+?) \((.+?), (.+?), (.+?)\)$/);
        if (!match) {
          return `<p class="text-white font-semibold">${segment}</p>`;
        }
        const [_, name, team, league, seasons] = match;
        return `
          <div class="ml-${idx * 4}">
            <p class="text-white font-semibold">${name}</p>
            <p class="text-gray-400 text-sm">↳ ${team} (${league}, ${seasons})</p>
          </div>`;
      }).join('');

      return `
        <div class="mb-6 border-b border-gray-700 pb-4">
          <p class="font-bold text-indigo-300 mb-2">#${i + 1}</p>
          ${pathLines}
          <p class="text-gray-400 text-xs mt-2">(${item.links} links)</p>
        </div>`;
    }).join('');
  });

  loadPlayerList();
</script>

</body>
</html>
